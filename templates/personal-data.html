<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RhythmFlow - 個人數據頁</title>
<style>
  /* ... 保留同學樣式 ... */
  body { margin: 0; font-family: Arial, sans-serif; background: #f9f9f9; color: #333; display: flex; flex-direction: column; height: 100vh; }
  header { background-color: #222; color: white; padding: 16px 24px; }
  nav { display: flex; gap: 24px; }
  nav a { color: white; text-decoration: none; font-size: 16px; padding: 8px 12px; border-radius: 4px; transition: background-color 0.3s; }
  nav a.active, nav a:hover { background-color: #4CAF50; }
  main { flex-grow: 1; padding: 24px 40px; box-sizing: border-box; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; width: 100%; }
  h1 { margin-top: 0; font-weight: bold; margin-bottom: 32px; font-size: 2rem; text-align: center; }
  
  /* 數據卡片樣式 */
  .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
  .stat-box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
  .stat-number { font-size: 2.5rem; font-weight: bold; color: #0078D7; margin: 10px 0; }
  .stat-label { color: #666; font-size: 1rem; }

  .history-list { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-grow: 1; overflow-y: auto; }
  .history-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
  .history-item:last-child { border-bottom: none; }
  .item-date { font-size: 0.9rem; color: #999; }
  .item-title { font-weight: bold; font-size: 1.1rem; }
  .item-score { background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }

  .back-home-btn-container { display: flex; justify-content: center; margin-top: 20px; padding-bottom: 24px; }
  .back-home-btn { background-color: #0078D7; color: white; border: none; padding: 14px 36px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
  .back-home-btn:hover { background-color: #005A9E; }
</style>
</head>
<body>
<header>
  <nav>
    <a href="/">首頁上傳區</a>
    <a href="#">音樂分析頁</a>
    <a href="#">運動執行頁</a>
    <a href="/results">運動成果頁</a>
    <a href="/personal" class="active">個人數據頁</a>
  </nav>
</header>
<main>
  <h1>個人數據儀表板</h1>
  
  <div class="stats-container">
    <div class="stat-box">
        <div class="stat-label">累積運動次數</div>
        <div class="stat-number" id="total-count">...</div>
        <div class="stat-label">次</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">累積運動時間</div>
        <div class="stat-number" id="total-time">...</div>
        <div class="stat-label">分鐘</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">平均滿意度</div>
        <div class="stat-number" id="avg-score">...</div>
        <div class="stat-label">分</div>
    </div>
  </div>

  <div class="history-list" id="history-container">
    <p style="text-align:center; color:#999;">載入資料中...</p>
  </div>

  <div class="back-home-btn-container">
    <button class="back-home-btn" id="back-home-btn">回首頁</button>
  </div>
</main>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
      const totalCountEl = document.getElementById('total-count');
      const totalTimeEl = document.getElementById('total-time');
      const avgScoreEl = document.getElementById('avg-score');
      const historyContainer = document.getElementById('history-container');

      try {
          // ★★★ 關鍵修改：呼叫後端 API 獲取資料庫數據 ★★★
          const res = await fetch('/api/get_history');
          
          if (!res.ok) {
              throw new Error('無法連接伺服器'); // 處理未登入或其他錯誤
          }

          const history = await res.json();

          if (history.length > 0) {
              let totalTimeSec = 0;
              let totalScore = 0;
              let listHtml = "";

              history.forEach(item => {
                  totalTimeSec += parseInt(item.duration || 0);
                  totalScore += parseInt(item.rating || 0);
                  
                  // 計算分秒
                  const min = Math.floor(item.duration / 60);
                  const sec = item.duration % 60;
                  
                  listHtml += `
                    <div class="history-item">
                        <div>
                            <div class="item-title">${item.songName}</div>
                            <div class="item-date">${item.date} • ${min}分${sec}秒</div>
                        </div>
                        <div class="item-score">滿意度: ${item.rating}</div>
                    </div>
                  `;
              });

              totalCountEl.textContent = history.length;
              totalTimeEl.textContent = (totalTimeSec / 60).toFixed(1); // 轉成分鐘
              avgScoreEl.textContent = (totalScore / history.length).toFixed(1);
              historyContainer.innerHTML = listHtml;
          } else {
              // 數據為空時清零
              totalCountEl.textContent = 0;
              totalTimeEl.textContent = 0;
              avgScoreEl.textContent = 0;
              historyContainer.innerHTML = '<p style="text-align:center; color:#999;">尚無運動紀錄</p>';
          }
      } catch (e) {
          console.error("讀取失敗", e);
          historyContainer.innerHTML = '<p style="text-align:center; color:red;">無法讀取資料，請確認您已登入。</p>';
      }
  });

  // 按鈕事件
  document.getElementById('back-home-btn').addEventListener('click', () => {
    window.location.href = '/';
  });
</script>
</body>
</html>